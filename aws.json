{
  "variables": {
    "aws_region": "eu-west-1",
    "aws_instance_type": "t2.micro",
    "aws_source_ami": "",
    "environment": "",
    "project": "",
    "function": "",
    "aws_ec2_profile": "",
    "module_paths": "",
    "root_volume_size":""
  },
  "builders": [{
    "type": "amazon-ebs",
    "region": "{{user `aws_region`}}",
    "source_ami": "{{user `aws_source_ami`}}",
    "instance_type": "{{user `aws_instance_type`}}",
    "iam_instance_profile": "{{user `aws_ec2_profile`}}",
    "ssh_username": "ubuntu",
    "ssh_pty" : true,
    "ami_name": "ebs-{{user `project`}}-{{user `function`}}-{{isotime \"200601020304\"}}",
    "ami_block_device_mappings": [
    {
      "device_name": "/dev/sda1",
      "volume_size": "{{user `root_volume_size`}}",
      "delete_on_termination": true
    }],
    "run_tags": {
    	"Project": "packer",
    	"Environment": "{{user `environment`}}"
  	},
    "tags": {
      "Project": "{{user `project`}}",
      "Environment": "{{user `environment`}}",
      "Node": "{{user `name`}}"
  	}
  }],
  "provisioners": [{
    "type": "shell",
    "inline": ["rm -Rf /tmp/hiera; mkdir -p /tmp/hiera; chmod 777 /tmp/hiera"]
  },
  {
    "type": "shell",
    "script": "scripts/updates.sh"
  },{
    "type": "shell",
    "script": "scripts/puppet_install.sh"
  },
  {
    "type": "file",
    "source": "puppet/hiera/",
    "destination": "/tmp/hiera/"
  },
  {
    "type": "puppet-masterless",
    "manifest_file": "puppet/manifests/default.pp",
    "module_paths": "{{user `module_paths`}}",
    "hiera_config_path": "puppet/hiera/hiera.yaml",
    "working_directory": "/tmp/hiera",
    "facter": {
      "function": "{{user `function`}}",
      "project": "{{user `project`}}",
      "ourenvironment": "{{user `environment`}}",
      "packerbuild": "true"
    }
  }]
}
