{
  "variables": {
    "aws_region": "eu-west-1",
    "aws_instance_type": "",
    "aws_source_ami": "",
    "environment": "",
    "project": "",
    "function": "",
    "aws_ec2_profile": "",
    "module_paths": "",
    "root_volume_size": "",
    "root_volume_type": "",
    "manifest_file": "",
    "hiera_config_path": "",
    "share_accounts": "",
    "hiera_path": ""
  },
  "builders": [{
    "type": "amazon-ebs",
    "region": "{{user `aws_region`}}",
    "source_ami": "{{user `aws_source_ami`}}",
    "instance_type": "{{user `aws_instance_type`}}",
    "iam_instance_profile": "{{user `aws_ec2_profile`}}",
    "ssh_username": "ubuntu",
    "ssh_pty" : true,
    "ami_name": "ebs-{{user `project`}}-{{user `function`}}-{{isotime \"200601020304\"}}",
    "ami_users": "{{user `share_accounts`}}",
    "snapshot_users": "{{user `share_accounts`}}",
    "ami_block_device_mappings": [
    {
      "device_name": "/dev/sda1",
      "volume_size": "{{user `root_volume_size`}}",
      "volume_type": "{{user `root_volume_type`}}",
      "delete_on_termination": true
    }],
    "run_tags": {
    	"Project": "packer",
    	"Environment": "{{user `environment`}}"
  	},
    "tags": {
      "Project": "{{user `project`}}",
      "Environment": "{{user `environment`}}",
      "Node": "{{user `name`}}"
  	}
  }],
  "provisioners": [{
    "type": "shell",
    "inline": ["rm -Rf /tmp/hiera; mkdir -p /tmp/hiera; chmod 777 /tmp/hiera"]
  },
  {
    "type": "shell",
    "script": "scripts/updates.sh"
  },{
    "type": "shell",
    "script": "scripts/puppet_install.sh"
  },
  {
    "type": "file",
    "source": "{{user `hiera_path`}}",
    "destination": "/tmp/hiera/"
  },
  {
    "type": "puppet-masterless",
    "manifest_file": "{{user `manifest_file`}}",
    "module_paths": "{{user `module_paths`}}",
    "hiera_config_path": "{{user `hiera_config_path`}}",
    "working_directory": "/tmp/hiera",
    "facter": {
      "function": "{{user `function`}}",
      "project": "{{user `project`}}",
      "ourenvironment": "{{user `environment`}}",
      "packerbuild": "true"
    }
  },{
    "type": "shell",
    "script": "scripts/cleanup.sh"
  }],
  "post-processors": [
    {
      "type": "manifest",
      "output": "packer_manifest.json",
      "strip_path": true
    }
  ]
}
